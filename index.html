<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Meal Tracker</title>

<style>
body {
  font-family: Arial, sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
  background:
    linear-gradient(rgba(255,255,255,0.3), rgba(255,255,255,0.3)),
    url("https://as2.ftcdn.net/v2/jpg/03/20/39/81/1000_F_320398182_1X1ebszxgKyeS6j291ywWYIw1dfRLETC.jpg")
    no-repeat center center;
  background-size: cover;
}

.container {
  background: rgba(255,255,255,0.85);
  padding: 30px 40px;
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  width: 100%;
  max-width: 420px;
  text-align: center;
}

h1 { font-size: 22px; margin-bottom: 8px; }
p { font-size: 14px; color: #555; margin-bottom: 15px; }

input {
  width: 100%;
  padding: 15px;
  font-size: 18px;
  border: 2px solid #ccc;
  border-radius: 6px;
}

input:focus { border-color: #007bff; }

#clock {
  font-size: 15px;
  font-weight: bold;
  margin-bottom: 10px;
}

#status {
  margin-top: 12px;
  font-size: 14px;
  font-weight: bold;
}

.success { color: green; }
.error { color: red; }

#lastScans {
  margin-top: 15px;
  text-align: left;
}

#scanList {
  list-style: none;
  padding: 0;
  margin: 0;
}

#scanList li {
  font-size: 13px;
  padding: 6px 8px;
  background: #f1f1f1;
  border-radius: 4px;
  margin-bottom: 6px;
}

.duplicate {
  background: #ffe5e5 !important;
  border-left: 5px solid #ff4d4d;
  color: #a10000;
}

button {
  margin-top: 10px;
  padding: 8px 12px;
  font-size: 13px;
  border: none;
  border-radius: 6px;
  background: #ff4d4d;
  color: white;
  cursor: pointer;
}

button:hover { opacity: 0.9; }

#totalCount {
  font-size: 15px;
  font-weight: bold;
  color: #29a745;
  margin-top: 15px;
}

/* ---------------- MODAL ---------------- */
.modal {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
}

.modal-content {
  background: #fff;
  margin: 8% auto;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 420px;
  max-height: 70vh;
  overflow-y: auto;
}

.modal-content h3 {
  margin-top: 0;
  text-align: center;
}

.close {
  float: right;
  font-size: 22px;
  font-weight: bold;
  cursor: pointer;
  color: #ff4d4d;
}

#duplicateList {
  list-style: none;
  padding: 0;
  margin-top: 15px;
}

#duplicateList li {
  padding: 8px;
  font-size: 13px;
  background: #ffe5e5;
  border-left: 5px solid #ff4d4d;
  border-radius: 4px;
  margin-bottom: 6px;
}
</style>
</head>

<body>

<div class="container">
  <div id="clock"></div>
  <h1>Pune P3 Daily Meal Tracker</h1>
  <p>Scan QR code using handheld scanner</p>

  <input type="text" id="qrInput" placeholder="Scan here..." autofocus>
  <div id="status"></div>

  <div id="lastScans">
    <h3>Last 5 Scans</h3>
    <ul id="scanList"></ul>
    <button id="showDuplicatesBtn">Show Duplicates</button>
  </div>

  <div id="totalCount">Total Scans: 0</div>
</div>

<!-- ---------- DUPLICATE POPUP ---------- -->
<div id="duplicateModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h3>Duplicate Scans (Today)</h3>
    <ul id="duplicateList"></ul>
  </div>
</div>

<script>
const webAppUrl = "https://script.google.com/macros/s/AKfycbxBFHqLh6bjDTpAHNf6qvGwMKFBQhgExYRRibRI4yLHlVKWD773ghV9UXzhqZ8RIBYn8Q/exec";

const input = document.getElementById("qrInput");
const status = document.getElementById("status");
const scanList = document.getElementById("scanList");
const totalCountEl = document.getElementById("totalCount");

const modal = document.getElementById("duplicateModal");
const closeModal = document.getElementById("closeModal");
const duplicateList = document.getElementById("duplicateList");
const showDuplicatesBtn = document.getElementById("showDuplicatesBtn");

const scannedSet = new Set();
const allScans = [];

/* -------- CLOCK -------- */
function updateClock() {
  const now = new Date();
  document.getElementById("clock").textContent =
    now.toLocaleDateString() + " | " + now.toLocaleTimeString();
}
setInterval(updateClock, 1000);
updateClock();

/* -------- AUDIO -------- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq, dur, type="sine") {
  if (audioCtx.state === "suspended") audioCtx.resume();
  const o = audioCtx.createOscillator();
  o.type = type;
  o.frequency.value = freq;
  o.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + dur / 1000);
}
const successBeep = () => beep(1200,120);
const duplicateBeep = () => beep(600,250,"triangle");
const invalidBeep = () => beep(300,350,"square");

/* -------- RENDER LAST 5 -------- */
function renderList() {
  scanList.innerHTML = "";
  allScans.slice(0,5).forEach(s => {
    const li = document.createElement("li");
    li.textContent = `${s.time} - ${s.qr}`;
    if (s.isDuplicate) li.classList.add("duplicate");
    scanList.appendChild(li);
  });
}

/* -------- SCAN -------- */
input.addEventListener("keydown", async e => {
  if (e.key !== "Enter") return;
  const qr = input.value.trim();
  input.value = "";
  if (!qr) return;

  try {
    const res = await fetch(webAppUrl + "?action=scan&data=" + encodeURIComponent(qr));
    const data = await res.json();

    if (data.error) {
      status.textContent = "✖ " + data.error;
      status.className = "error";
      invalidBeep();
      return;
    }

    const isDup = data.isDuplicate || scannedSet.has(qr);
    allScans.unshift({
      qr,
      time: new Date().toLocaleTimeString(),
      isDuplicate: isDup
    });

    scannedSet.add(qr);
    renderList();

    if (isDup) {
      status.textContent = "⚠ Duplicate Scan";
      status.className = "error";
      duplicateBeep();
    } else {
      status.textContent = "✔ Scan Saved";
      status.className = "success";
      successBeep();
    }

    totalCountEl.textContent = "Total Scans: " + data.total;

  } catch {
    status.textContent = "✖ Network Error";
    status.className = "error";
    invalidBeep();
  }
});

/* -------- SHOW DUPLICATES POPUP -------- */
showDuplicatesBtn.addEventListener("click", async () => {
  modal.style.display = "block";
  duplicateList.innerHTML = "<li>Loading...</li>";

  try {
    const res = await fetch(webAppUrl + "?action=duplicates");
    const data = await res.json();

    duplicateList.innerHTML = "";

    if (!data.duplicates || data.duplicates.length === 0) {
      duplicateList.innerHTML = "<li>No duplicates found</li>";
      return;
    }

    data.duplicates.forEach(d => {
      const li = document.createElement("li");
      li.textContent = `${d.time} - ${d.qr}`;
      duplicateList.appendChild(li);
    });

  } catch {
    duplicateList.innerHTML = "<li>Error loading duplicates</li>";
  }
});

/* -------- CLOSE MODAL -------- */
closeModal.onclick = () => modal.style.display = "none";
window.onclick = e => {
  if (e.target === modal) modal.style.display = "none";
};

setInterval(()=>input.focus(),500);
</script>

</body>
</html>
