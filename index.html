<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Meal Tracker</title>

<style>
body {
  font-family: Arial, sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
  background:
    linear-gradient(rgba(255,255,255,0.3), rgba(255,255,255,0.3)),
    url("https://as2.ftcdn.net/v2/jpg/03/20/39/81/1000_F_320398182_1X1ebszxgKyeS6j291ywWYIw1dfRLETC.jpg")
    no-repeat center center;
  background-size: cover;
}

/* TOTAL SCAN BUTTON */
#totalBtn {
  position: fixed;
  top: 15px;
  right: 15px;
  padding: 10px 16px;
  font-size: 14px;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  background: #007bff;
  color: white;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

#totalBtn:hover {
  background: #0056b3;
}

.container {
  background: rgba(255,255,255,0.9);
  padding: 30px 40px;
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  width: 100%;
  max-width: 420px;
  text-align: center;
}

h1 { font-size: 22px; margin-bottom: 8px; }
p { font-size: 14px; color: #555; }

input {
  width: 100%;
  padding: 15px;
  font-size: 18px;
  border: 2px solid #ccc;
  border-radius: 6px;
}

#clock {
  font-size: 14px;
  font-weight: bold;
  margin-bottom: 10px;
}

#status {
  margin-top: 12px;
  font-size: 14px;
  font-weight: bold;
}

.success { color: green; }
.error { color: red; }

#scanList li {
  font-size: 13px;
  padding: 6px 8px;
  border-radius: 4px;
  margin-bottom: 6px;
  background: #f1f1f1;
}

.dup-yellow { background: #fff2cc !important; border-left: 5px solid #f0ad4e; }
.dup-red { background: #ffe5e5 !important; border-left: 5px solid #ff4d4d; }

#totalCount {
  font-size: 18px;
  font-weight: bold;
  color: #007bff;
  margin-top: 15px;
}
</style>
</head>

<body>

<!-- TOTAL SCANS BUTTON -->
<button id="totalBtn">Total Scans</button>

<div class="container">
  <div id="clock"></div>
  <h1>Pune P3 Daily Meal Tracker</h1>
  <p>Scan QR code using handheld scanner</p>

  <input type="text" id="qrInput" placeholder="Scan here..." autofocus>
  <div id="status"></div>

  <ul id="scanList"></ul>

  <div id="totalCount">Total Scans: 0</div>
</div>

<script>
const webAppUrl =
"https://script.google.com/macros/s/AKfycbxBFHqLh6bjDTpAHNf6qvGwMKFBQhgExYRRibRI4yLHlVKWD773ghV9UXzhqZ8RIBYn8Q/exec";

/* ELEMENTS */
const input = document.getElementById("qrInput");
const status = document.getElementById("status");
const scanList = document.getElementById("scanList");
const totalCountEl = document.getElementById("totalCount");
const totalBtn = document.getElementById("totalBtn");

const allScans = [];

/* CLOCK */
setInterval(() => {
  const n = new Date();
  document.getElementById("clock").textContent =
    n.toLocaleDateString() + " | " + n.toLocaleTimeString();
}, 1000);

/* AUDIO */
const ctx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq, dur, type="sine") {
  if (ctx.state === "suspended") ctx.resume();
  const o = ctx.createOscillator();
  o.type = type;
  o.frequency.value = freq;
  o.connect(ctx.destination);
  o.start();
  o.stop(ctx.currentTime + dur / 1000);
}

/* SCAN */
input.addEventListener("keydown", async e => {
  if (e.key !== "Enter") return;

  const qr = input.value.trim();
  input.value = "";
  if (!qr) return;

  try {
    const res = await fetch(webAppUrl + "?data=" + encodeURIComponent(qr));
    const data = await res.json();

    if (data.error) {
      status.textContent = "âœ– " + data.error;
      status.className = "error";
      beep(300,300,"square");
      return;
    }

    allScans.unshift({ qr, count: data.count });
    scanList.innerHTML = "";

    allScans.slice(0,5).forEach(s => {
      const li = document.createElement("li");
      li.textContent = s.qr;
      if (s.count === 2) li.classList.add("dup-yellow");
      if (s.count >= 3) li.classList.add("dup-red");
      scanList.appendChild(li);
    });

    status.textContent =
      data.count === 1 ? "âœ” Scan Saved"
      : data.count === 2 ? "ðŸŸ¡ Duplicate (2nd)"
      : `ðŸ”´ Duplicate (${data.count})`;

    status.className = data.count === 1 ? "success" : "error";
    beep(data.count === 1 ? 1200 : 600, 200);

    totalCountEl.textContent = "Total Scans: " + data.total;

  } catch {
    status.textContent = "âœ– Network Error";
    status.className = "error";
  }
});

/* TOTAL BUTTON CLICK â€” LIVE FROM SHEET */
totalBtn.addEventListener("click", async () => {
  try {
    const res = await fetch(webAppUrl + "?action=total");
    const data = await res.json();

    if (data.total !== undefined) {
      alert("Total Scans (Sheet): " + data.total);
    } else {
      alert("Total not returned");
    }
  } catch (err) {
    alert("Network Error");
  }
});


/* KEEP FOCUS */
setInterval(() => input.focus(), 500);
</script>

</body>
</html>
